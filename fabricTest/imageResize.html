<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fabric.js Drag Container Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.js"></script>
  </head>
  <body>
    <canvas
      id="c"
      width="1000"
      height="1000"
      style="border: 1px solid #ccc"
    ></canvas>
    <script >
      const canvas = new fabric.Canvas("c",{
        uniformScaling:false
      });
      // fabric.Object.prototype.originX = "center";
      // fabric.Object.prototype.originY = "center";

      // 定位框
      canvas.add(new fabric.Rect({
        left: 300,
        top: 300,
        width: 300,
        height: 300,
        fill: "rgba(0,0,0,0)", // 透明背景
        stroke: "gray", // 边框颜色
        strokeWidth: 1,
        lockUniScaling: false,
        lockScalingFlip: true,
        selectable:false,

      }));



      // 相框
      const frameRect = new fabric.Rect({
        left: 300,
        top: 300,
        width: 300,
        height: 100,
        fill: "rgba(0,0,0,0)", // 透明背景
        stroke: "blue", // 边框颜色
        borderColor:"blue",
        strokeWidth: 1,
        lockUniScaling: false,
        lockScalingFlip: true,
        strokeUniform: true,

        // objectCaching: false,
      });
      window.frameRect = frameRect;






      fabric.Image.fromURL(
        "https://craftypixels.com/placeholder-image/400x400/bdbd00/000000&text=400",
        function (img400) {
          img400.set({
            left: 0,
            top: 0,
            // left:container.left - (img400.width*rate)/2,
            // top:container.top  - (img400.height*rate)/2,
            // height:container.height,
            // width:container.width,
            // originX: 'center',
            // originY: 'center',
            // scaleX: rate,
            // scaleY: rate,
            // width:container.width,
            // height:container.height,
          });
          // 添加图像和容器到画布
          window.img400 = img400;
          canvas.add(img400);

          canvas.requestRenderAll();
        }
      );




      const container = new fabric.Group([frameRect],{
        originX: 'center',
        originY: 'center',
        // selectable:false,
        borderColor:"red",
        // evented:false,
        subTargetCheck:true,
      });
      
      canvas.add(container);

      
      // 创建图像
      fabric.Image.fromURL(
        "https://craftypixels.com/placeholder-image/800x800/bd0000/000000&text=800",
        function (img800) {
          let rate1  = container.height / img800.height ;
          let rate2 = container.width / img800.width;
          let rate = rate1 < rate2 ? rate1 : rate2;
          img800.set({
            left: container.left,
            top: container.top,
            // left:container.left - (img800.width*rate)/2,
            // top:container.top  - (img800.height*rate)/2,
            // height:container.height,
            // width:container.width,
            originX: 'center',
            originY: 'center',
            scaleX: rate,
            scaleY: rate,
            width: img800.width,
            height: img800.height,
          });

        
          // 添加图像和容器到画布
          container.addWithUpdate(img800);
          window.img800 = img800;

          canvas.requestRenderAll();
        }
      );

        // "mousedown",
        container.on("scaling", (e) => {
          console.log("scaling e ",e,)
          // let rate1  = container.getBoundingRect().height / img800.height ;
          // let rate2 = container.getBoundingRect().width / img800.width;
          let rate1 = container.scaleX * img800.scaleX;
          let rate2  = container.scaleY * img800.scaleY;
          
          // 逆矩阵
          const inverseGroupMatrix = fabric.util.invertTransform(container.calcTransformMatrix());
          console.log("rate1*inverseGroupMatrix[0]",rate1*inverseGroupMatrix[0])
          console.log("img800.getBoundingRect(true,true).height",img800.getBoundingRect(true,true).height)
          let rate = rate1 < rate2 ? rate1 : rate2;
          console.log('rate',rate1,rate2,inverseGroupMatrix)
          img800.set({
            
            scaleX: rate1*inverseGroupMatrix[0],
            scaleY: rate2*inverseGroupMatrix[3],
            // scaleY: rate,
            // scaleY: rate1,
            // scaleX: rate,
            // scaleY: rate2,
          });
          canvas.renderAll();
        });

      
      // canvas.setActiveObject(frameRect);
    </script>
  </body>
</html>
